---
title: "Lecture F1. MDP without Model 1"  
author: "Baek, Jong min"  
date: "`r Sys.Date()`"  
output:   
  pdf_document:
    fig_caption: false  
    latex_engine: xelatex
    highlight: haddock  
    keep_tex: true  
    includes:
      in_header: rmd-pdf-support/latex-topmatter.tex
    # pandoc_args: [
    #  "-V", "classoption=twocolumn"
    toc: true   
    toc_depth: 2  
    # number_sections: true  
monofont: Consolas
smaller: yes
classoption: a4paper
---
```{r setup, include=FALSE}
library(rmarkdown)
library(reticulate)

matplotlib <- import("matplotlib")
matplotlib$use("Agg", force = TRUE)

knitr::opts_chunk$set(echo = TRUE) # 코드를 보여준다.
knitr::opts_chunk$set(background = '718CBA')  # ??
```

```{python, include=FALSE}
import numpy as np
import matplotlib.pyplot as plt
import pandas as pd
```

\newpage

## Preparation

```{python}
states = np.arange(0,80,10).astype(str)
p_normal = pd.DataFrame(np.array([
0,1,0,0,0,0,0,0,
0,0,1,0,0,0,0,0,
0,0,0,1,0,0,0,0,
0,0,0,0,1,0,0,0,
0,0,0,0,0,1,0,0,
0,0,0,0,0,0,1,0,
0,0,0,0,0,0,0,1,
0,0,0,0,0,0,0,1
]).reshape(8,8),index=states, columns=states)
p_speed = pd.DataFrame(np.array([
.1,0,.9,0,0,0,0,0,
.1,0,0,.9,0,0,0,0,
0,.1,0,0,.9,0,0,0,
0,0,.1,0,0,.9,0,0,
0,0,0,.1,0,0,.9,0,
0,0,0,0,.1,0,0,.9,
0,0,0,0,0,.1,0,.9,
0,0,0,0,0,0,0,1,
]).reshape(8,8),index=states, columns=states)
p_normal
p_speed
```

```{python}
R_s_a = pd.DataFrame(np.array([-1,-1,-1,-1,0.0,-1,-1,0,-1.5,-1.5,-1.5,-1.5,-0.5,-1.5,-1.5,0]).reshape(8,2,order='F'),columns=['n','s'],index=states)
R_s_a.T
```


```{python}
pi_speed = pd.DataFrame(np.c_[np.zeros(len(states)),np.repeat(1,len(states))],columns=['n','s'],index=states)
pi_50 = pd.DataFrame(np.c_[np.repeat(0.5,len(states)),np.repeat(0.5,len(states))],columns=['n','s'],index=states)
print(pi_speed.T)
print(pi_50.T)
```
\newpage

## Simulation - pi_speed

```{python}
pi = pi_speed
np.random.seed(1234)
history = []
MC_N = 10000

for MC_i in range(MC_N):
  s_now = '0'
  history_i = list(s_now)

  while s_now !='70' :
    if np.random.uniform(0,1) < pi.loc[s_now,'n'] :
      a_now = 'n'
      P = p_normal
    else:
      a_now = 's'
      P = p_speed
      
    r_now = str(R_s_a.loc[s_now,a_now])
    s_next = states[np.argmin(P.loc[s_now].cumsum() < np.random.uniform(0,1))]
    history_i.extend([a_now,r_now,s_next])
    s_now = s_next
  history.append(history_i)
history_speed = history
```

```{python}
pd.Series(map(lambda x : ','.join(x), history_speed[:20]))
```
\newpage

## Siumlator pi_50

```{python}
pi = pi_50
np.random.seed(1234)
history = []
MC_N = 10000

for MC_i in range(MC_N):
  s_now = '0'
  history_i = list(s_now)

  while s_now !='70' :
    if np.random.uniform(0,1) < pi.loc[s_now,'n'] :
      a_now = 'n'
      P = p_normal
    else:
      a_now = 's'
      P = p_speed
      
    r_now = str(R_s_a.loc[s_now,a_now]) 
    s_next = states[np.argmin(np.cumsum(P.loc[s_now]) < np.random.uniform(0,1))]
    history_i.extend([a_now,r_now,s_next])
    s_now = s_next
  history.append(history_i)
history_50 = history
```

```{python}
pd.Series(map(lambda x : ','.join(x), history_50[:20]))
```
\newpage

## Implementation1-pi_speed(vetorized)(page 17-18)

```{python}
pol_eval = pd.DataFrame(np.zeros(shape=(len(states),2)),columns=['count','sum'],index=states)
print(pol_eval.T)
```
```{python}
for MC_i in range(len(history_speed)):
  history_i = history_speed[MC_i]
  for j in range(0,len(history_i),3):
    pol_eval.loc[history_i[j],'count'] += 1
    if j < len(history_i):
        pol_eval.loc[history_i[j],'sum'] += np.sum(np.asarray(history_i)[range(j+2,len(history_i)-1,3)].astype('float'))
    else :
        pol_eval.loc[history_i[j],'sum'] +=  0
```

```{python}
print(pol_eval.T)
print(pol_eval.loc[:,'sum']/pol_eval.loc[:,'count'])
```
\newpage

## Implementation2 - pi_speed(running estimate)(page 19-20)

```{python}
pol_eval = pd.DataFrame(np.zeros(shape=(len(states),2)),columns=['count','est'],index=states)
pol_eval.T
```

```{python}
for MC_i in range(len(history_speed)):
  history_i = history_speed[MC_i]
  for j in range(0,len(history_i),3):
  
  # updated count
    pol_eval.loc[history_i[j],'count'] += 1
    current_cnt = pol_eval.loc[history_i[j],'count']
    
    # return is the new info
    if j < len(history_i) :
      new_info = np.sum(np.asarray(history_i)[range(j+2,len(history_i)-1,3)].astype('float'))
    else:
      new_info = 0
      
  # update the last estimate with new info
    alpha = 1/current_cnt
    pol_eval.loc[history_i[j],'est'] += alpha*(new_info - pol_eval.loc[history_i[j],'est'])
```

```{python}
print(round(pol_eval.T,1))
```
\newpage

## Implementation2 - pi_50(running estimate)(page 21-22)

```{python}
pol_eval = pd.DataFrame(np.zeros(shape=(len(states),2)),columns=['count','sum'],index=states)
print(pol_eval.T)
```

```{python}
for MC_i in range(len(history_50)):
  history_i = history_50[MC_i]
  for j in range(0,len(history_i),3):
    pol_eval.loc[history_i[j],'count'] += 1
    if j < len(history_i):
        pol_eval.loc[history_i[j],'sum'] += np.sum(np.asarray(history_i)[range(j+2,len(history_i)-1,3)].astype('float'))
    else :
        pol_eval.loc[history_i[j],'sum'] +=  0
```

```{python}
print(pol_eval.T)
print(pol_eval.loc[:,'sum']/pol_eval.loc[:,'count'])
```
\newpage

## Implementation4 - pi_50(running estimate)(page 23-24)

```{python}
pol_eval = pd.DataFrame(np.zeros(shape=(len(states),2)),columns=['count','est'],index=states)
pol_eval.T
```

```{python}
for MC_i in range(len(history_50)):
  history_i = history_50[MC_i]
  for j in range(0,len(history_i),3):

  # updated count
    pol_eval.loc[history_i[j],'count'] += 1
    current_cnt = pol_eval.loc[history_i[j],'count']

    # return is the new info
    if j < len(history_i) :
      new_info = np.sum(np.asarray(history_i)[range(j+2,len(history_i)-1,3)].astype('float'))
    else:
      new_info = 0

  # update the last estimate with new info
    alpha = 1/current_cnt
    pol_eval.loc[history_i[j],'est'] += alpha*(new_info - pol_eval.loc[history_i[j],'est'])
```

```{python}
print(round(pol_eval.T),1)
```

\newpage
## Temporal Difference policy Evaluation

### Implementation 5 - pi_speed(page 35-36)
```{python}
pol_eval = pd.DataFrame(np.zeros(shape=(len(states),2)),columns=['count','est'],index=states)

for MC_i in range(len(history_speed)):
  history_i = history_speed[MC_i]
  
  for j in range(0,len(history_i),3):
    # updated count
    pol_eval.loc[history_i[j],'count'] += 1
    current_cnt = pol_eval.loc[history_i[j],'count']
    
    # build TD target
    if j < len(history_i)-3 :
      TD_tgt = np.array(history_i[j+2]).astype('float')+ pol_eval.loc[history_i[j+3]]['est']
    else :
      TD_tgt = 0
  
  # update the last estimate with new info
    alpha = 1/current_cnt
    pol_eval.loc[history_i[j],'est'] += alpha*(TD_tgt - pol_eval.loc[history_i[j],'est'])
    
print(pol_eval.T)
```

\newpage
### Implementation 6 - pi_50(page 37-38)
```{python}
pol_eval = pd.DataFrame(np.zeros(shape=(len(states),2)),columns=['count','est'],index=states)

for MC_i in range(len(history_50)):
  history_i = history_50[MC_i]
  
  for j in range(0,len(history_i),3):
    # updated count
    pol_eval.loc[history_i[j],'count'] += 1
    current_cnt = pol_eval.loc[history_i[j],'count']
    
    # build TD target
    if j < len(history_i)-3 :
      TD_tgt = np.array(history_i[j+2]).astype('float')+ pol_eval.loc[history_i[j+3]]['est']
    else :
      TD_tgt = 0
  
  # update the last estimate with new info
    alpha = 1/current_cnt
    pol_eval.loc[history_i[j],'est'] += alpha*(TD_tgt - pol_eval.loc[history_i[j],'est'])
    
print(pol_eval.T)
```

\newpage

F1.Rmd
```{r}
"Hello"
```

