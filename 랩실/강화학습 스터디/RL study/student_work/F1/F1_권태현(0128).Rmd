---
title: "F1"
author: "Tae Hyeon Kwon, undergrad(ITM)"
date: '`r Sys.Date()`'
output: pdf_document
---

```{python}
import numpy as np
import pandas as pd


states = np.arange(0,80,10).astype('str')

P_normal = pd.DataFrame(np.matrix([[0,1,0,0,0,0,0,0],
                    [0,0,1,0,0,0,0,0],
                    [0,0,0,1,0,0,0,0],
                    [0,0,0,0,1,0,0,0],
                    [0,0,0,0,0,1,0,0],
                    [0,0,0,0,0,0,1,0],
                    [0,0,0,0,0,0,0,1],
                    [0,0,0,0,0,0,0,1]]), index=states,columns=states)

P_speed=pd.DataFrame(np.matrix([[.1,0,.9,0,0,0,0,0],
                   [.1,0,0,.9,0,0,0,0],
                   [0,.1,0,0,.9,0,0,0],
                   [0,0,.1,0,0,.9,0,0],
                   [0,0,0,.1,0,0,.9,0],
                   [0,0,0,0,.1,0,0,.9],
                   [0,0,0,0,0,.1,0,.9],
                   [0,0,0,0,0,0,0,1]]), index=states, columns=states)

R_s_a=pd.DataFrame(np.matrix([-1,-1,-1,-1,0.0,-1,-1,0,-1.5,-1.5,-1.5,-1.5,-0.5,-1.5,-1.5,0]).reshape(len(states),2,order='F'),columns=['n','s'],index=states)

print(R_s_a.T)

pi_speed=pd.DataFrame(np.c_[np.repeat(0,len(states)),np.repeat(1,len(states))], index=states, columns=['n','s'])

pi_50=pd.DataFrame(np.c_[np.repeat(0.5,len(states)), np.repeat(0.5,len(states))],index=states, columns=['n','s'])



print(pi_speed.T)

print(pi_50.T)

#simulator pi_speed

pi = pi_speed
np.random.seed(1234)
history = list()
MC_N = 10000
for MC_i in range(MC_N):
    s_now = '0'
    history_i = list(s_now)

    while s_now != '70':
        if np.random.uniform(0, 1) < pi.loc[s_now]['n']:
            a_now = 'n'
            P = P_normal
        else:
            a_now = 's'
            P = P_speed

        r_now = str(R_s_a.loc[s_now][a_now])
        s_next = states[np.argmin(P.loc[s_now].cumsum() < np.random.uniform(0, 1))].item()
        history_i.extend([a_now, r_now, s_next])
        s_now = s_next

    history.append(history_i)

history_speed = history
func = np.vectorize(lambda x: ','.join(x))
print(pd.Series(func(history_speed[:20])))

#simulator pi_50

pi = pi_50
np.random.seed(1234)
history = list()
MC_N = 10000
for MC_i in range(MC_N):
    s_now = '0'
    history_i = list(s_now)

    while s_now != '70':
        if np.random.uniform(0, 1) < pi.loc[s_now]['n']:
            a_now = 'n'
            P = P_normal
        else:
            a_now = 's'
            P = P_speed

        r_now = str(R_s_a.loc[s_now][a_now])
        s_next = states[np.argmin(P.loc[s_now].cumsum() < np.random.uniform(0, 1))].item()
        history_i.extend([a_now, r_now, s_next])
        s_now = s_next

    history.append(history_i)

history_50 = history
func = np.vectorize(lambda x: ','.join(x))
pd.Series(func(history_50[:20]))

#implementation pi_speed (vectorized)

pol_eval = pd.DataFrame(np.zeros((len(states), 2)), index=states, columns=['count', 'sum'])
print(pol_eval.T)


for MC_i in range(len(history_speed)):
    history_i = history_speed[MC_i]

    for j in range(0, len(history_i), 3):
        pol_eval.loc[history_i[j]]['count'] += 1

        if j < len(history_i):
            pol_eval.loc[history_i[j]]['sum'] += pd.Series(history_i)[range(j + 2, len(history_i) - 1, 3)].astype(
                'float').sum()

        else:
            pol_eval.loc[history_i[j]]['sum'] += 0

print(pol_eval.T)

print((pol_eval['sum'] / pol_eval['count']))

#implementation pi_speed (running estimate)

pol_eval = pd.DataFrame(np.zeros((len(states), 2)), index=states, columns=['count', 'est'])
print(pol_eval.T)

for MC_i in range(len(history_speed)):
    history_i = history_speed[MC_i]

    for j in range(0, len(history_i), 3):
        pol_eval.loc[history_i[j]]['count'] += 1
        current_cnt = pol_eval.loc[history_i[j]]['count']

        if j < len(history_i):
            new_info = pd.Series(history_i)[range(j + 2, len(history_i) - 1, 3)].astype('float').sum()

        else:
            new_info = 0

        alpha = 1 / current_cnt
        pol_eval.loc[history_i[j]]['est'] += alpha * (new_info - pol_eval.loc[history_i[j]]['est'])

print(np.round(pol_eval.T, 2))

#implementation pi_50 (vectorized)

pol_eval = pd.DataFrame(np.zeros((len(states), 2)), index=states, columns=['count', 'sum'])
print(pol_eval.T)

for MC_i in range(len(history_50)):
    history_i = history_50[MC_i]

    for j in range(0, len(history_i), 3):
        pol_eval.loc[history_i[j]]['count'] += 1

        if j < len(history_i):
            pol_eval.loc[history_i[j]]['sum'] += pd.Series(history_i)[range(j + 2, len(history_i) - 1, 3)].astype(
                'float').sum()

        else:
            pol_eval.loc[history_i[j]]['sum'] += 0

print(pol_eval.T)

print(pol_eval['sum'] / pol_eval['count'])

#implementation pi_speed (running estimate)

pol_eval = pd.DataFrame(np.zeros((len(states), 2)), index=states, columns=['count', 'est'])
print(pol_eval.T)

for MC_i in range(len(history_50)):
    history_i = history_50[MC_i]

    for j in range(0, len(history_i), 3):
        pol_eval.loc[history_i[j]]['count'] += 1
        current_cnt = pol_eval.loc[history_i[j]]['count']

        if j < len(history_i):
            new_info = pd.Series(history_i)[range(j + 2, len(history_i) - 1, 3)].astype('float').sum()

        else:
            new_info = 0

        alpha = 1 / current_cnt
        pol_eval.loc[history_i[j]]['est'] += alpha * (new_info - pol_eval.loc[history_i[j]]['est'])

print(np.round(pol_eval.T, 2))


#TD - pi_speed
pol_eval = pd.DataFrame(np.zeros((len(history_speed),2)), index= states, columns=['count','est'])

print(pol_eval.T)

for episode_i in range(len(history_speed)):
    history_i = history_speed[episode_i]

    for j in range(0,len(history_i[j]),3):
        pol_eval.loc[history_i[j]]['count']+=1
        current_cnt = pol_eval.loc[history_i[j]]['count']
        if (j+3) < len(history_i):
            TD_tgt = float(history_i[j+2])+pol_eval.loc[history_i[j+3]]['est']
        else:
            TD_tgt = 0

        alpha = 1/current_cnt
        pol_eval.loc[history_i[j]]['est']+=alpha*((TD_tgt)-(pol_eval.loc[history_i[j]]['est']))


print(pol_eval.T)

#TD - pi_50

pol_eval = pd.DataFrame(np.zeros((len(history_speed),2)), index= states, columns=['count','est'])

print(pol_eval.T)

for episode_i in range(len(history_50)):
    history_i = history_50[episode_i]

    for j in range(0,len(history_i[j]),3):
        pol_eval.loc[history_i[j]]['count']+=1
        current_cnt = pol_eval.loc[history_i[j]]['count']
        if (j+3) < len(history_i):
            TD_tgt = float(history_i[j+2])+pol_eval.loc[history_i[j+3]]['est']
        else:
            TD_tgt = 0

        alpha = 1/current_cnt
        pol_eval.loc[history_i[j]]['est']+=alpha*((TD_tgt)-(pol_eval.loc[history_i[j]]['est']))


print(pol_eval.T)



```

