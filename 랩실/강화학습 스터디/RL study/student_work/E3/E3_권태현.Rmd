---
title: "E3"
author: "Kwon"
date: '2021 1 22 '
output: pdf_document
---

```{python}
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt

gamma = 1
states = np.arange(0,80,10).astype('str')

P_normal = pd.DataFrame(np.matrix([[0,1,0,0,0,0,0,0],
                                 [0,0,1,0,0,0,0,0],
                                 [0,0,0,1,0,0,0,0],
                                 [0,0,0,0,1,0,0,0],
                                 [0,0,0,0,0,1,0,0],
                                 [0,0,0,0,0,0,1,0],
                                 [0,0,0,0,0,0,0,1],
                                 [0,0,0,0,0,0,0,1]]), index=states, columns=states)

P_speed = pd.DataFrame(np.matrix([[0.1,0,0.9,0,0,0,0,0],
                                 [0.1,0,0,0.9,0,0,0,0],
                                 [0,0.1,0,0,0.9,0,0,0],
                                 [0,0,0.1,0,0,0.9,0,0],
                                 [0,0,0,0.1,0,0,0.9,0],
                                 [0,0,0,0,0.1,0,0,0.9],
                                 [0,0,0,0,0,0.1,0,0.9],
                                 [0,0,0,0,0,0,0,1]]), index=states, columns=states)


R_s_a = pd.DataFrame(np.matrix([-1,-1,-1,-1,0.0,-1,-1,0,-1.5,-1.5,-1.5,-1.5,-0.5,-1.5,-1.5,0]).reshape(len(states),2,order='F'),columns=['normal','speed'],index=states)

#1. Initialize V
V_old = pd.DataFrame(np.repeat(0,len(states)).reshape(len(states),1),index= states)
print(V_old.T)

#2. Evaluate the Q-function
q_s_a = R_s_a + np.c_[np.dot(gamma*P_normal,V_old),np.dot(gamma*P_speed,V_old)]
print(q_s_a)

#3. Find the bset action for each state
V_new = np.matrix(q_s_a.apply(max,axis=1)).reshape(len(states),1)
print(V_new.T)

#Assigned are gamma states, P_normal, P_speed, R_s_a
cnt = 0
epsilon = 10**(-8)
V_old = pd.DataFrame(np.repeat(0,len(states)).reshape(len(states),1),index= states)
results = V_old.T

while True:
    q_s_a = R_s_a + np.c_[np.dot(gamma*P_normal,V_old),np.dot(gamma*P_speed,V_old)]
    V_new = np.matrix(q_s_a.apply(max,axis=1)).reshape(len(states),1)
    if np.max(np.abs(V_new-V_old)).item() < epsilon:
        break
    results = np.r_[results, V_new.T]
    V_old = V_new
    cnt = cnt+1

value_iter_process = results
results = pd.DataFrame(results, columns=states)

print(results.head(n=7))

print(results.tail(n=7))

#iteration from 1 to 6
plt.plot(results.columns,results.iloc[0], label='1',marker='o')
plt.plot(results.columns,results.iloc[1], label='2',marker='o')
plt.plot(results.columns,results.iloc[2], label='3',marker='o')
plt.plot(results.columns,results.iloc[3], label='4',marker='o')
plt.plot(results.columns,results.iloc[4], label='5',marker='o')
plt.plot(results.columns,results.iloc[5], label='6',marker='o')
plt.grid(True)
plt.legend(title='factor(idx)')
plt.xlabel('state')
plt.ylabel('value_fn')
plt.title('Iteration from 1 to 6', fontweight='bold')
plt.show()

#iteration from 7 to 12
plt.plot(results.columns,results.iloc[6], label='7',marker='o')
plt.plot(results.columns,results.iloc[7], label='8',marker='o')
plt.plot(results.columns,results.iloc[8], label='9',marker='o')
plt.plot(results.columns,results.iloc[9], label='10',marker='o')
plt.plot(results.columns,results.iloc[10], label='11',marker='o')
plt.plot(results.columns,results.iloc[11], label='12',marker='o')
plt.grid(True)
plt.legend(title='factor(idx)')
plt.xlabel('state')
plt.ylabel('value_fn')
plt.title('Iteration from 7 to 12', fontweight='bold')
plt.show()

#iteration from 13 to 18
plt.plot(results.columns,results.iloc[12], label='13',marker='o')
plt.plot(results.columns,results.iloc[13], label='14',marker='o')
plt.plot(results.columns,results.iloc[14], label='15',marker='o')
plt.plot(results.columns,results.iloc[15], label='16',marker='o')
plt.plot(results.columns,results.iloc[16], label='17',marker='o')
plt.plot(results.columns,results.iloc[17], label='18',marker='o')
plt.grid(True)
plt.legend(title='factor(idx)')
plt.xlabel('state')
plt.ylabel('value_fn')
plt.title('Iteration from 13 to 18', fontweight='bold')
plt.show()


#optimal policy
V_opt = results.tail(1).T
print(V_opt.T)

q_s_a = R_s_a + np.c_[np.dot(gamma*P_normal,V_old),np.dot(gamma*P_speed,V_old)]
print(q_s_a)

pi_opt_vec = q_s_a.idxmax(axis=1)
print(pi_opt_vec)

pi_opt_vec = pd.DataFrame(np.zeros((len(states),2)), index=states, columns=['normal','speed'])
for i in (1,len(pi_opt_vec)):
    pi_opt_vec.iloc[i][pi_opt_vec[i]]=1
print(pi_opt_vec.T)
```